<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Waterjet NC File Reader</title>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .app-header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .app-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .app-main {
            flex: 1;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .scanner-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .job-view {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .job-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .job-header h2 {
            color: #2c3e50;
            margin-left: 20px;
        }

        .job-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        .left-panel, .right-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .enhanced-features {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .enhanced-features h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .feature-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .error-detection {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .error-detection h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-item {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ff9800;
        }

        .error-item.warning {
            border-left-color: #ffeb3b;
            background: #fffef0;
        }

        .error-item.critical {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .coordinate-systems {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .coordinate-system {
            background: #2196f3;
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .gcode-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .gcode-line {
            padding: 2px 5px;
            border-radius: 3px;
        }

        .gcode-line.rapid {
            background: rgba(244, 67, 54, 0.2);
            color: #ffcdd2;
        }

        .gcode-line.cutting {
            background: rgba(76, 175, 80, 0.2);
            color: #c8e6c9;
        }

        .gcode-line.comment {
            color: #81c784;
            font-style: italic;
        }

        .scan-button, .manual-button, .job-button, .back-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .scan-button:hover, .manual-button:hover, .job-button:hover, .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .scanner-controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .sample-jobs {
            margin-top: 30px;
        }

        .sample-jobs h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .job-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .job-button {
            padding: 12px 25px;
            font-size: 1rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-button {
            background: #667eea;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .canvas-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .canvas-container canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            display: block;
            margin: 0 auto;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        .legend-color.rapid {
            background: #ff4444;
            background-image: linear-gradient(to right, #ff4444 50%, transparent 50%);
            background-size: 10px 2px;
        }

        .legend-color.cutting {
            background: #4444ff;
        }

        .legend-color.pierce {
            background: #ffff00;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .app-main {
                padding: 10px;
            }

            .app-header h1 {
                font-size: 2rem;
            }

            .job-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .job-buttons {
                flex-direction: column;
            }

            .coordinate-systems {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Simplified NC Parser for debugging
        function parseNCFile(content) {
            console.log('Parsing NC file:', content);
            const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const toolPath = [];
            let cuttingPerimeter = 0;
            let piercingCount = 0;
            let rapidLength = 0;
            let totalFeedRates = [];
            let errors = [];
            let warnings = [];
            
            // Track bounds for better visualization
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            
            // Coordinate systems
            let activeCoordinateSystem = 'G54';
            let currentPlane = 'G17'; // XY plane
            let absoluteMode = true;
            
            let currentPos = { x: 0, y: 0, z: 0 };
            let sequence = 0;
            let lastMoveType = 'rapid';

            for (let lineNum = 0; lineNum < lines.length; lineNum++) {
                const line = lines[lineNum];
                const originalLine = line;
                
                // Skip empty lines and comments
                if (line.startsWith(';') || line.startsWith('(') || line.trim() === '') {
                    toolPath.push({
                        type: 'comment',
                        command: 'COMMENT',
                        start: { ...currentPos },
                        end: { ...currentPos },
                        sequence,
                        originalLine
                    });
                    sequence++;
                    continue;
                }

                try {
                    const tokens = line.toUpperCase().split(/[\s,]+/);
                    
                    const x = tokens.find(t => t.startsWith('X'))?.substring(1);
                    const y = tokens.find(t => t.startsWith('Y'))?.substring(1);
                    const z = tokens.find(t => t.startsWith('Z'))?.substring(1);
                    const f = tokens.find(t => t.startsWith('F'))?.substring(1);
                    const gCommand = tokens.find(t => t.startsWith('G'))?.substring(1);

                    if (!gCommand) {
                        continue;
                    }

                    const newPos = {
                        x: x ? parseFloat(x) : currentPos.x,
                        y: y ? parseFloat(y) : currentPos.y,
                        z: z ? parseFloat(z) : currentPos.z
                    };

                    let moveType, command;
                    switch (gCommand) {
                        case '0': moveType = 'rapid'; command = 'G00'; break;
                        case '1': moveType = 'cutting'; command = 'G01'; break;
                        case '2': moveType = 'cutting'; command = 'G02'; break;
                        case '3': moveType = 'cutting'; command = 'G03'; break;
                        case '28': 
                            command = 'G28'; 
                            newPos.x = 0; newPos.y = 0; newPos.z = 25;
                            break;
                        case '30': 
                            command = 'G30'; 
                            newPos.x = 0; newPos.y = 0; newPos.z = 25;
                            break;
                        case '90': 
                            absoluteMode = true; 
                            continue;
                        case '91': 
                            absoluteMode = false; 
                            continue;
                        case '21': command = 'G21'; continue; // Metric
                        case '54': activeCoordinateSystem = 'G54'; continue;
                        case '55': activeCoordinateSystem = 'G55'; continue;
                        default:
                            warnings.push(`Line ${lineNum + 1}: Unsupported G-code G${gCommand}`);
                            continue;
                    }

                    const isPiercePoint = (lastMoveType === 'rapid' && moveType === 'cutting');
                    const feedRate = f ? parseFloat(f) : 50;

                    toolPath.push({
                        type: moveType,
                        command,
                        start: { ...currentPos },
                        end: newPos,
                        feedRate: moveType === 'cutting' ? feedRate : undefined,
                        isPiercePoint,
                        sequence,
                        coordinateSystem: activeCoordinateSystem,
                        plane: currentPlane,
                        absoluteMode,
                        originalLine
                    });

                    // Update bounds
                    minX = Math.min(minX, newPos.x);
                    maxX = Math.max(maxX, newPos.x);
                    minY = Math.min(minY, newPos.y);
                    maxY = Math.max(maxY, newPos.y);

                    if (moveType === 'cutting') {
                        const distance = Math.sqrt((newPos.x - currentPos.x) ** 2 + (newPos.y - currentPos.y) ** 2);
                        cuttingPerimeter += distance;
                        totalFeedRates.push(feedRate);
                    } else {
                        const distance = Math.sqrt((newPos.x - currentPos.x) ** 2 + (newPos.y - currentPos.y) ** 2);
                        rapidLength += distance;
                    }

                    if (isPiercePoint) piercingCount++;
                    
                    currentPos = newPos;
                    lastMoveType = moveType;
                    sequence++;
                } catch (error) {
                    errors.push(`Line ${lineNum + 1}: Parse error - ${error.message}: ${originalLine}`);
                }
            }

            const averageSpeed = totalFeedRates.length > 0 
                ? totalFeedRates.reduce((sum, speed) => sum + speed, 0) / totalFeedRates.length
                : 50;

            const result = {
                toolPath,
                cuttingPerimeter,
                piercingCount,
                rapidLength,
                cuttingSpeed: averageSpeed,
                boundingBox: {
                    minX: minX === Infinity ? 0 : minX,
                    maxX: maxX === -Infinity ? 300 : maxX,
                    minY: minY === Infinity ? 0 : minY,
                    maxY: maxY === -Infinity ? 300 : maxY
                },
                errors,
                warnings,
                activeCoordinateSystem,
                currentPlane,
                totalMoves: sequence
            };

            console.log('Parsed result:', result);
            return result;
        }

        // Mock Database - Sample Jobs
        const mockDatabase = {
            'SHEET-3670': {
                jobId: 'SHEET-3670',
                client: 'SMB Engineers',
                material: { type: 'Stainless Steel', thickness: 30 },
                sheetName: 'SHEET-3670',
                sheetSize: { width: 1000, height: 2000 },
                machine: {
                    name: 'AWJ',
                    pressure: 3200,
                    orifice: 0.330,
                    abrasiveQuality: 'GMA Garnet 80 (0.92)',
                    nozzleDiameter: 0.889,
                    abrasiveFlow: 450,
                    toolDiameter: 1.000
                },
                cuttingParameters: {
                    rapidLength: 4522.445,
                    cuttingLength: 3849.428,
                    averageSpeed: 49.167,
                    cuttingTime: 78.28,
                    totalTime: 79.17
                },
                parts: [{
                    name: 'SMB Eng 30 mm SS waterjet (√ó2)',
                    customer: 'SMB Engineers',
                    quantity: 2,
                    cuttingLength: 1924.714,
                    weight: 45.0,
                    singleTime: 39.14,
                    totalTime: 78.28
                }],
                estimatedTimes: {
                    rapid: 0.88,
                    marking: 0,
                    piercing: 0,
                    drilling: 0,
                    cutting: 78.28,
                    total: 79.17
                }
            },
            'TEST-1234': {
                jobId: 'TEST-1234',
                client: 'ABC Manufacturing',
                material: { type: 'Aluminum', thickness: 10 },
                sheetName: 'TEST-1234',
                sheetSize: { width: 500, height: 1000 },
                machine: {
                    name: 'AWJ',
                    pressure: 3800,
                    orifice: 0.330,
                    abrasiveQuality: 'GMA Garnet 80 (0.92)',
                    nozzleDiameter: 0.889,
                    abrasiveFlow: 350,
                    toolDiameter: 1.000
                },
                cuttingParameters: {
                    rapidLength: 800.0,
                    cuttingLength: 1200.0,
                    averageSpeed: 120.0,
                    cuttingTime: 10.0,
                    totalTime: 10.5
                },
                parts: [{
                    name: 'Aluminum bracket',
                    customer: 'ABC Manufacturing',
                    quantity: 1,
                    cuttingLength: 1200.0,
                    weight: 2.5,
                    singleTime: 10.0,
                    totalTime: 10.0
                }],
                estimatedTimes: {
                    rapid: 0.5,
                    marking: 0,
                    piercing: 0,
                    drilling: 0,
                    cutting: 10.0,
                    total: 10.5
                }
            }
        };

        const mockNCFiles = {
            'SHEET-3670': `; Waterjet cutting program for SHEET-3670
; Material: Stainless Steel 30mm
; Client: SMB Engineers

G21
G90
G54

G00 X0 Y0 Z25.0
M08

G00 X50 Y50 Z25.0
G00 Z2.0
G01 Z0 F500
G01 X50 Y150 F49.167
G01 X100 Y150 F49.167
G01 X100 Y50 F49.167
G01 X50 Y50 F49.167

G00 X200 Y50 Z25.0
G00 Z2.0
G01 Z0 F500
G01 X200 Y150 F49.167
G01 X250 Y150 F49.167
G01 X250 Y50 F49.167
G01 X200 Y50 F49.167

G00 X0 Y0 Z25.0
M09
M30`,
            'TEST-1234': `; Simple aluminum cutting test
G21 G90 G54
G00 X0 Y0 Z25.0
M08
G00 X25 Y25 Z2.0
G01 Z0 F300
G01 X75 Y25 F120
G01 X75 Y75 F120
G01 X25 Y75 F120
G01 X25 Y25 F120
G00 Z25.0
M09
M30`
        };

        // Cut Time Calculator
        function calculateCutTime(pierceCount, pierceTimePerPiece, cuttingPerimeter, cuttingSpeed) {
            const piercingTime = pierceCount * pierceTimePerPiece;
            const cuttingTime = cuttingPerimeter / cuttingSpeed;
            const totalTime = piercingTime + cuttingTime;
            return { piercingTime, cuttingTime, totalTime };
        }

        // Format Time
        function formatTime(minutes) {
            const totalSeconds = Math.round(minutes * 60);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes_remaining = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes_remaining.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // File Upload Component
        function FileUpload({ onFileLoaded, loading }) {
            const [dragActive, setDragActive] = useState(false);

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            };

            const handleChange = (e) => {
                e.preventDefault();
                if (e.target.files && e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            };

            const handleFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    onFileLoaded(content, file.name);
                };
                reader.readAsText(file);
            };

            return (
                <div className="scanner-section">
                    <h3>üìÅ Upload NC Files</h3>
                    <div 
                        className={`upload-area ${dragActive ? 'dragover' : ''}`}
                        onDragEnter={handleDrag}
                        onDragLeave={handleDrag}
                        onDragOver={handleDrag}
                        onDrop={handleDrop}
                    >
                        <h4>Drag & drop your NC file here</h4>
                        <p>Supported formats: .nc, .gcode, .txt, .ngc</p>
                        <label className="upload-button">
                            Choose File
                            <input 
                                type="file" 
                                accept=".nc,.gcode,.txt,.ngc"
                                onChange={handleChange}
                                disabled={loading}
                            />
                        </label>
                    </div>
                </div>
            );
        }

        // Sample Jobs Component
        function SampleJobs({ onJobSelect, loading }) {
            return (
                <div className="sample-jobs">
                    <h3>Available Sample Jobs:</h3>
                    <div className="job-buttons">
                        <button
                            onClick={() => onJobSelect('SHEET-3670')}
                            disabled={loading}
                            className="job-button"
                        >
                            SHEET-3670 (SMB Engineers - Stainless Steel)
                        </button>
                        <button
                            onClick={() => onJobSelect('TEST-1234')}
                            disabled={loading}
                            className="job-button"
                        >
                            TEST-1234 (ABC Manufacturing - Aluminum)
                        </button>
                    </div>
                </div>
            );
        }

        // Error Detection Component
        function ErrorDetection({ errors, warnings }) {
            if (errors.length === 0 && warnings.length === 0) {
                return (
                    <div className="success-message">
                        ‚úÖ No errors detected in G-code
                    </div>
                );
            }

            return (
                <div className="error-detection">
                    <h4>üîç G-code Analysis Results</h4>
                    
                    {errors.length > 0 && (
                        <div>
                            <h5 style={{ color: '#f44336' }}>‚ö†Ô∏è Errors ({errors.length}):</h5>
                            <ul className="error-list">
                                {errors.map((error, index) => (
                                    <li key={index} className="error-item critical">
                                        {error}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                    
                    {warnings.length > 0 && (
                        <div>
                            <h5 style={{ color: '#ff9800' }}>‚ö†Ô∏è Warnings ({warnings.length}):</h5>
                            <ul className="error-list">
                                {warnings.map((warning, index) => (
                                    <li key={index} className="error-item warning">
                                        {warning}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        }

        // Enhanced Features Display Component
        function EnhancedFeatures({ parsedData }) {
            return (
                <div className="enhanced-features">
                    <h3>‚öôÔ∏è Enhanced Features</h3>
                    <div className="feature-grid">
                        <div className="feature-item">
                            <strong>Coordinate System:</strong><br/>
                            {parsedData.activeCoordinateSystem}
                        </div>
                        <div className="feature-item">
                            <strong>Active Plane:</strong><br/>
                            {parsedData.currentPlane}
                        </div>
                        <div className="feature-item">
                            <strong>Total Commands:</strong><br/>
                            {parsedData.totalMoves}
                        </div>
                        <div className="feature-item">
                            <strong>Positioning Mode:</strong><br/>
                            {parsedData.absoluteMode ? 'Absolute' : 'Relative'}
                        </div>
                    </div>
                </div>
            );
        }

        // Coordinate Systems Display Component
        function CoordinateSystems({ activeSystem }) {
            const systems = ['G54', 'G55', 'G56', 'G57', 'G58', 'G59'];
            return (
                <div>
                    <h4>üìê Coordinate Systems</h4>
                    <div className="coordinate-systems">
                        {systems.map(system => (
                            <div 
                                key={system} 
                                className="coordinate-system"
                                style={{ 
                                    background: system === activeSystem ? '#4caf50' : '#2196f3'
                                }}
                            >
                                {system}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Job Details Component
        function JobDetails({ jobData }) {
            return (
                <div>
                    <h3>üìã Job Details</h3>
                    
                    <div className="details-section">
                        <h4>Client Information</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '20px' }}>
                            <div><strong>Client:</strong> {jobData.client}</div>
                            <div><strong>Sheet ID:</strong> {jobData.sheetName}</div>
                        </div>
                    </div>

                    <div className="details-section">
                        <h4>Material Specifications</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '20px' }}>
                            <div><strong>Material:</strong> {jobData.material.type}</div>
                            <div><strong>Thickness:</strong> {jobData.material.thickness} mm</div>
                            <div><strong>Sheet Size:</strong> {jobData.sheetSize.width} √ó {jobData.sheetSize.height} mm</div>
                        </div>
                    </div>

                    <div className="details-section">
                        <h4>Machine Parameters</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '20px' }}>
                            <div><strong>Machine:</strong> {jobData.machine.name}</div>
                            <div><strong>Pressure:</strong> {jobData.machine.pressure} bar</div>
                            <div><strong>Orifice:</strong> {jobData.machine.orifice} mm</div>
                            <div><strong>Nozzle:</strong> {jobData.machine.nozzleDiameter} mm</div>
                            <div><strong>Abrasive:</strong> {jobData.machine.abrasiveQuality}</div>
                            <div><strong>Flow Rate:</strong> {jobData.machine.abrasiveFlow} g/min</div>
                        </div>
                    </div>

                    <div className="details-section">
                        <h4>Cutting Statistics</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '20px' }}>
                            <div><strong>Cutting Perimeter:</strong> {jobData.parsedData.cuttingPerimeter.toFixed(2)} mm</div>
                            <div><strong>Piercing Points:</strong> {jobData.parsedData.piercingCount}</div>
                            <div><strong>Rapid Length:</strong> {jobData.parsedData.rapidLength.toFixed(2)} mm</div>
                            <div><strong>Avg Cutting Speed:</strong> {jobData.cuttingSpeed.toFixed(2)} mm/min</div>
                        </div>
                    </div>

                    <div className="details-section">
                        <h4>Edge Quality Cutting Speeds (mm/min)</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px', marginBottom: '20px' }}>
                            {jobData.cuttingParameters.edgeQualitySpeeds && Object.entries(jobData.cuttingParameters.edgeQualitySpeeds).map(([quality, speed]) => (
                                <div key={quality} style={{ background: '#f8f9fa', padding: '8px', borderRadius: '5px', textAlign: 'center' }}>
                                    <div style={{ fontWeight: 'bold', color: '#2c3e50' }}>{quality}</div>
                                    <div style={{ fontSize: '1.1em', color: '#667eea' }}>{speed.toFixed(1)}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="details-section">
                        <h4>Time Breakdown (Calculated)</h4>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                            <div><strong>Piercing Time:</strong> {formatTime(jobData.parsedData.piercingCount * 0.5)}</div>
                            <div><strong>Cutting Time:</strong> {formatTime(jobData.parsedData.cuttingPerimeter / jobData.cuttingSpeed)}</div>
                            <div style={{ gridColumn: '1 / -1', fontWeight: 'bold', fontSize: '1.2em', color: '#667eea' }}>
                                <strong>Total Time:</strong> {formatTime((jobData.parsedData.piercingCount * 0.5) + (jobData.parsedData.cuttingPerimeter / jobData.cuttingSpeed))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Fixed Simulation Canvas Component
        function SimulationCanvas({ ncFileContent, parsedData, jobData }) {
            const canvasRef = useRef(null);

            useEffect(() => {
                console.log('SimulationCanvas useEffect triggered', { ncFileContent, parsedData, jobData });
                
                if (!canvasRef.current || !parsedData || !parsedData.toolPath) {
                    console.log('Missing required data for canvas');
                    return;
                }

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get canvas context');
                    return;
                }

                const width = 800;
                const height = 600;
                canvas.width = width;
                canvas.height = height;

                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);
                
                // Calculate bounds and scale
                const bounds = parsedData.boundingBox;
                console.log('Bounds:', bounds);
                
                let widthRange = bounds.maxX - bounds.minX;
                let heightRange = bounds.maxY - bounds.minY;
                
                // Ensure minimum ranges for visibility
                if (widthRange < 50) widthRange = 100;
                if (heightRange < 50) heightRange = 100;
                
                const scaleX = (width * 0.8) / widthRange;
                const scaleY = (height * 0.8) / heightRange;
                const scale = Math.min(scaleX, scaleY);
                
                const offsetX = (width - widthRange * scale) / 2 - bounds.minX * scale;
                const offsetY = (height - heightRange * scale) / 2 - bounds.minY * scale;
                
                console.log('Scale calculations:', { scale, offsetX, offsetY, widthRange, heightRange });

                // Draw grid
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 0.5;
                const gridSize = 20 * scale;
                
                for (let x = 0; x < width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }
                for (let y = 0; y < height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }

                // Draw coordinate axes
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(offsetX, 0);
                ctx.lineTo(offsetX, height);
                ctx.moveTo(0, offsetY);
                ctx.lineTo(width, offsetY);
                ctx.stroke();

                // Draw tool path
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                let currentPos = { x: 0, y: 0 };
                let moveCount = 0;
                
                console.log('ToolPath length:', parsedData.toolPath.length);
                
                parsedData.toolPath.forEach((move, index) => {
                    if (move.type === 'comment') return; // Skip comments
                    
                    const startX = currentPos.x * scale + offsetX;
                    const startY = currentPos.y * scale + offsetY;
                    const endX = move.end.x * scale + offsetX;
                    const endY = move.end.y * scale + offsetY;
                    
                    // Draw move
                    if (move.type === 'rapid') {
                        ctx.strokeStyle = '#ff4444';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 5]);
                    } else if (move.type === 'cutting') {
                        ctx.strokeStyle = '#4444ff';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([]);
                    } else {
                        return;
                    }
                    
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                    
                    // Draw pierce points
                    if (move.isPiercePoint) {
                        ctx.fillStyle = '#ffff00';
                        ctx.beginPath();
                        ctx.arc(startX, startY, 6, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        
                        ctx.fillStyle = '#000';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText((index + 1).toString(), startX, startY - 10);
                    }
                    
                    // Draw tool position
                    ctx.fillStyle = '#00aa00';
                    ctx.beginPath();
                    ctx.arc(endX, endY, 3, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    currentPos = move.end;
                    moveCount++;
                });

                console.log('Drew', moveCount, 'moves');
            }, [parsedData, jobData, ncFileContent]);

            return (
                <div>
                    <h3>üîß Cutting Simulation</h3>
                    <div className="canvas-container">
                        <canvas ref={canvasRef} width="800" height="600" />
                        
                        <div className="legend">
                            <div className="legend-item">
                                <div className="legend-color rapid"></div>
                                <span>Rapid Moves (G00)</span>
                            </div>
                            <div className="legend-item">
                                <div className="legend-color cutting"></div>
                                <span>Cutting Moves (G01/G02/G03)</span>
                            </div>
                            <div className="legend-item">
                                <div className="legend-color pierce"></div>
                                <span>Pierce Points</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', fontSize: '0.9em' }}>
                        <div><strong>Total Moves:</strong> {parsedData.toolPath.length}</div>
                        <div><strong>Cutting Moves:</strong> {parsedData.toolPath.filter(m => m.type === 'cutting').length}</div>
                        <div><strong>Rapid Moves:</strong> {parsedData.toolPath.filter(m => m.type === 'rapid').length}</div>
                        <div><strong>Pierce Points:</strong> {parsedData.piercingCount}</div>
                        <div><strong>Active Coord System:</strong> {parsedData.activeCoordinateSystem}</div>
                        <div><strong>Current Plane:</strong> {parsedData.currentPlane}</div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [currentJob, setCurrentJob] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleJobSelect = async (jobId) => {
                console.log('Selected job:', jobId);
                setLoading(true);
                setError(null);

                try {
                    const job = mockDatabase[jobId];
                    if (!job) {
                        setError(`Job with ID '${jobId}' not found`);
                        setCurrentJob(null);
                        return;
                    }

                    const ncFileContent = mockNCFiles[jobId];
                    console.log('NC file content:', ncFileContent);
                    
                    const parsedData = parseNCFile(ncFileContent);
                    console.log('Parsed data:', parsedData);

                    const pierceTimePerPiece = 0.5;
                    const cuttingSpeed = job.cuttingParameters.averageSpeed || 50;
                    const cutTimeResult = calculateCutTime(
                        parsedData.piercingCount,
                        pierceTimePerPiece,
                        parsedData.cuttingPerimeter,
                        cuttingSpeed
                    );

                    const jobData = {
                        ...job,
                        ncFileContent,
                        cuttingSpeed,
                        pierceTime: pierceTimePerPiece,
                        parsedData: {
                            ...parsedData,
                            approxCutTime: cutTimeResult.totalTime
                        }
                    };

                    console.log('Final job data:', jobData);
                    setCurrentJob(jobData);
                } catch (err) {
                    console.error('Error fetching job:', err);
                    setError('Failed to load job data: ' + err.message);
                    setCurrentJob(null);
                } finally {
                    setLoading(false);
                }
            };

            // Enhanced parameter calculation functions based on Python algorithms
            const materialFactors = {
                "Aluminum (2024)": 0.8,
                "Aluminum (6061)": 0.8,
                "Brass (360)": 0.9,
                "Bronze": 0.9,
                "Copper (C110)": 0.9,
                "Carbon Steel Generic (Hard)": 1.2,
                "Carbon Steel Generic (Mild)": 1.0,
                "Carbon Steel A572": 1.1,
                "Granite (Black)": 0.343,
                "Inconel (625)": 1.5,
                "Invar (36)": 1.3,
                "Lead": 0.5,
                "Mild Steel (A36)": 1.0,
                "Stainless Steel (304)": 1.2,
                "Stainless Steel (316)": 1.2,
                "Titanium (6AL-4V)": 1.5,
                "Tool Steel (RC 60)": 1.4
            };

            const edgeQualityFactors = {
                "A. Rough": 1.0,
                "B. Coarse": 1.23,
                "C. Medium": 1.78,
                "D. Smooth": 2.67,
                "E. Fine": 4.20
            };

            const estimateMaterialThickness = (cuttingSpeed, perimeter, pierceCount) => {
                // Use the Python algorithm approach for better accuracy
                // Calculate complexity factor
                const complexity = pierceCount / Math.max(perimeter / 1000, 1);

                // Estimate thickness using reverse calculation from cutting speed formula
                // Formula: speed = 3.06 * (P^0.8) * (Pw^0.5) * (A^0.3) * (O^0.4) / (thickness^1.38 * Qg * Mf)
                // Assuming typical machine parameters, we can estimate thickness

                let estimatedThickness = 10; // Default starting point

                // Use cutting speed ranges to estimate thickness
                if (cuttingSpeed > 150) estimatedThickness = 3; // Very thin
                else if (cuttingSpeed > 80) estimatedThickness = 6; // Thin
                else if (cuttingSpeed > 40) estimatedThickness = 12; // Medium
                else if (cuttingSpeed > 20) estimatedThickness = 25; // Thick
                else if (cuttingSpeed > 10) estimatedThickness = 50; // Very thick
                else estimatedThickness = 100; // Ultra thick

                // Adjust for complexity (more pierces = thicker material)
                if (complexity > 0.8) estimatedThickness *= 1.4;
                else if (complexity > 0.4) estimatedThickness *= 1.2;
                else if (complexity < 0.1) estimatedThickness *= 0.8;

                return Math.max(1, Math.min(200, estimatedThickness));
            };

            const calculateMachineParameters = (thickness, cuttingSpeed, perimeter) => {
                // Use the Python algorithm formulas for more accurate calculations
                // Fixed machine parameters for Streamline SL-V 50 Plus
                const fixedParams = {
                    waterPressure: 4137, // bar
                    orificeSize: 0.35,   // mm
                    focusTube: 1.050,    // mm
                    abrasiveRate: 0.4,   // kg/min
                    pumpPower: 37.3      // kW
                };

                // Calculate pressure based on thickness (higher pressure for thicker materials)
                let pressure = 2000 + (thickness * 25);
                pressure = Math.max(2000, Math.min(6000, pressure));

                // Orifice diameter based on thickness and pressure requirements
                let orifice = 0.25 + (thickness / 100) * 0.15;
                orifice = Math.max(0.2, Math.min(0.5, orifice));

                // Nozzle diameter (focus tube) - typically 3:1 ratio with orifice
                let nozzle = orifice * 3;
                nozzle = Math.max(0.75, Math.min(1.5, nozzle));

                // Abrasive flow rate calculation using Python algorithm approach
                // Flow rate based on pressure, orifice, and nozzle
                let flowRate = (pressure / 1000) * (orifice * 100) * (nozzle * 100) * 0.6;
                flowRate = Math.max(200, Math.min(800, flowRate));

                // Select abrasive quality based on material thickness
                let abrasiveQuality = 'GMA Garnet 80';
                if (thickness > 50) abrasiveQuality = 'GMA Garnet 120';
                else if (thickness > 25) abrasiveQuality = 'GMA Garnet 100';
                else if (thickness < 5) abrasiveQuality = 'GMA Garnet 60';

                return {
                    pressure: Math.round(pressure),
                    orifice: Math.round(orifice * 1000) / 1000,
                    nozzleDiameter: Math.round(nozzle * 1000) / 1000,
                    abrasiveFlow: Math.round(flowRate),
                    abrasiveQuality,
                    toolDiameter: Math.round((nozzle + 0.2) * 1000) / 1000
                };
            };

            const estimateMaterialType = (thickness, cuttingSpeed) => {
                // Use material factor ranges from Python algorithm
                if (thickness <= 3) return 'Aluminum (6061)';
                if (thickness <= 6) return cuttingSpeed > 100 ? 'Aluminum (2024)' : 'Copper (C110)';
                if (thickness <= 12) return cuttingSpeed > 75 ? 'Stainless Steel (304)' : 'Mild Steel (A36)';
                if (thickness <= 25) return 'Carbon Steel Generic (Mild)';
                if (thickness <= 50) return 'Carbon Steel Generic (Hard)';
                if (thickness <= 100) return 'Tool Steel (RC 60)';
                return 'Titanium (6AL-4V)';
            };

            // Calculate cutting speeds for different edge qualities using Python formula
            const calculateCuttingSpeeds = (thickness, materialType, machineParams) => {
                const speeds = {};
                const materialFactor = materialFactors[materialType] || 1.0;

                for (const [quality, Qg] of Object.entries(edgeQualityFactors)) {
                    // Python formula: speed = 3.06 * (P^0.8) * (Pw^0.5) * (A^0.3) * (O^0.4) / (thickness^1.38 * Qg * materialFactor)
                    const P = machineParams.pressure;
                    const Pw = 37.3; // Fixed pump power
                    const A = machineParams.abrasiveFlow / 1000; // Convert to kg/min
                    const O = machineParams.orifice;

                    const numerator = 3.06 * Math.pow(P, 0.8) * Math.pow(Pw, 0.5) * Math.pow(A, 0.3) * Math.pow(O, 0.4);
                    const denominator = Math.pow(thickness, 1.38) * Qg * materialFactor;

                    speeds[quality] = numerator / denominator;
                }

                return speeds;
            };

            const handleFileLoaded = (content, filename) => {
                console.log('File loaded:', filename, 'Content length:', content.length);
                setLoading(true);
                setError(null);

                try {
                    const parsedData = parseNCFile(content);
                    console.log('Parsed uploaded file:', parsedData);

                    if (!parsedData.toolPath || parsedData.toolPath.length === 0) {
                        throw new Error('No valid G-code commands found in the file');
                    }

                    // Calculate actual sheet size from bounds
                    const bounds = parsedData.boundingBox;
                    const width = Math.max(50, bounds.maxX - bounds.minX); // Minimum 50mm
                    const height = Math.max(50, bounds.maxY - bounds.minY); // Minimum 50mm

                    // Estimate material properties from cutting data
                    const estimatedThickness = estimateMaterialThickness(
                        parsedData.cuttingSpeed,
                        parsedData.cuttingPerimeter,
                        parsedData.piercingCount
                    );

                    const materialType = estimateMaterialType(estimatedThickness, parsedData.cuttingSpeed);

                    // Calculate machine parameters based on estimated material
                    const machineParams = calculateMachineParameters(
                        estimatedThickness,
                        parsedData.cuttingSpeed,
                        parsedData.cuttingPerimeter
                    );

                    // Calculate cutting speeds for different edge qualities
                    const cuttingSpeeds = calculateCuttingSpeeds(estimatedThickness, materialType, machineParams);

                    const jobData = {
                        jobId: 'UPLOADED-' + Date.now(),
                        client: filename.replace(/\.[^/.]+$/, ""), // Remove extension
                        material: {
                            type: materialType,
                            thickness: Math.round(estimatedThickness * 10) / 10 // Round to 1 decimal
                        },
                        sheetName: filename,
                        sheetSize: {
                            width: Math.round(width),
                            height: Math.round(height)
                        },
                        machine: {
                            name: 'AWJ',
                            ...machineParams
                        },
                        cuttingParameters: {
                            rapidLength: parsedData.rapidLength,
                            cuttingLength: parsedData.cuttingPerimeter,
                            averageSpeed: parsedData.cuttingSpeed,
                            cuttingTime: parsedData.cuttingPerimeter / parsedData.cuttingSpeed,
                            totalTime: (parsedData.piercingCount * 0.5) + (parsedData.cuttingPerimeter / parsedData.cuttingSpeed),
                            edgeQualitySpeeds: cuttingSpeeds // Add edge quality speed predictions
                        },
                        parts: [{
                            name: filename.replace(/\.[^/.]+$/, ""),
                            customer: 'Uploaded File',
                            quantity: 1,
                            cuttingLength: parsedData.cuttingPerimeter,
                            weight: Math.round((width * height * estimatedThickness * 0.000008) * 10) / 10, // Rough weight calculation
                            singleTime: parsedData.cuttingPerimeter / parsedData.cuttingSpeed,
                            totalTime: parsedData.cuttingPerimeter / parsedData.cuttingSpeed
                        }],
                        estimatedTimes: {
                            rapid: Math.round(parsedData.rapidLength / 1000) / 10, // Convert to minutes
                            marking: 0,
                            piercing: parsedData.piercingCount * 0.5,
                            drilling: 0,
                            cutting: parsedData.cuttingPerimeter / parsedData.cuttingSpeed,
                            total: (parsedData.piercingCount * 0.5) + (parsedData.cuttingPerimeter / parsedData.cuttingSpeed)
                        },
                        ncFileContent: content,
                        cuttingSpeed: parsedData.cuttingSpeed,
                        pierceTime: 0.5,
                        parsedData
                    };

                    console.log('Created uploaded job data:', jobData);
                    setCurrentJob(jobData);
                } catch (err) {
                    console.error('Error parsing uploaded file:', err);
                    setError(`Failed to parse uploaded file: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleReset = () => {
                setCurrentJob(null);
                setError(null);
            };

            return (
                <div className="app">
                    <header className="app-header">
                        <h1>üîß Fixed Waterjet NC File Reader</h1>
                        <p>Enhanced G-code Analysis & Cutting Simulation</p>
                    </header>

                    <main className="app-main">
                        {!currentJob && (
                            <div className="scanner-section">
                                <div className="scanner-controls">
                                    <h3>üì± Quick Access</h3>
                                    <p>Use the sample jobs below or upload your own NC files</p>
                                </div>

                                <FileUpload
                                    onFileLoaded={handleFileLoaded}
                                    loading={loading}
                                />

                                <SampleJobs
                                    onJobSelect={handleJobSelect}
                                    loading={loading}
                                />
                            </div>
                        )}

                        {currentJob && (
                            <div className="job-view">
                                <div className="job-header">
                                    <button onClick={handleReset} className="back-button">
                                        ‚Üê Back to Jobs
                                    </button>
                                    <h2>{currentJob.client} - {currentJob.material.type}</h2>
                                </div>

                                <div className="job-content">
                                    <div className="left-panel">
                                        <JobDetails jobData={currentJob} />
                                        
                                        {/* Enhanced Features */}
                                        <EnhancedFeatures parsedData={currentJob.parsedData} />
                                        
                                        {/* Coordinate Systems */}
                                        <CoordinateSystems activeSystem={currentJob.parsedData.activeCoordinateSystem} />
                                        
                                        {/* Error Detection */}
                                        <ErrorDetection 
                                            errors={currentJob.parsedData.errors} 
                                            warnings={currentJob.parsedData.warnings} 
                                        />
                                    </div>

                                    <div className="right-panel">
                                        <SimulationCanvas 
                                            ncFileContent={currentJob.ncFileContent}
                                            parsedData={currentJob.parsedData}
                                            jobData={currentJob}
                                        />
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {loading && (
                        <div className="loading-overlay">
                            <div className="loading-spinner"></div>
                            <p>Loading job data...</p>
                        </div>
                    )}

                    {error && (
                        <div style={{
                            position: 'fixed',
                            top: '20px',
                            right: '20px',
                            background: '#e74c3c',
                            color: 'white',
                            padding: '15px 20px',
                            borderRadius: '8px',
                            boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                            zIndex: 1000,
                            maxWidth: '400px'
                        }}>
                            ‚ùå {error}
                            <button 
                                onClick={() => setError(null)}
                                style={{ 
                                    marginLeft: '10px', 
                                    background: 'none', 
                                    border: 'none', 
                                    color: 'white', 
                                    cursor: 'pointer',
                                    fontSize: '16px'
                                }}
                            >
                                √ó
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>